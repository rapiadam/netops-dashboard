name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target'
        required: true
        type: choice
        options: [staging, production]
      dry_run:
        description: 'Dry run only'
        type: boolean
        default: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible
        run: pip install ansible && ansible-galaxy collection install community.docker

      - name: Write vault password
        run: |
          if [ -z "$VAULT_PASS" ]; then
            echo "::error::ANSIBLE_VAULT_PASSWORD secret is not set. Go to Settings > Secrets > Actions and add it."
            exit 1
          fi
          echo "$VAULT_PASS" > /tmp/.vault_pass
          chmod 600 /tmp/.vault_pass
        env:
          VAULT_PASS: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Deploy
        run: |
          FLAGS=""
          [ "${{ inputs.dry_run }}" = "true" ] && FLAGS="--check --diff"
          ansible-playbook ansible/playbooks/site.yml \
            -i ansible/inventory/hosts.yml \
            --vault-password-file /tmp/.vault_pass \
            $FLAGS

      - name: Cleanup
        if: always()
        run: rm -f /tmp/.vault_pass
